<!DOCTYPE html>
<html>
<head>
    <title>Phishing Detection UI</title>
    <meta charset="utf-8"/>
    <!-- Ensures better responsiveness on mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/style.css" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
</head>
<body>
    <div class="wrapper">
        <header class="app-header">
            <h1>üõ°Ô∏è VectorShield</h1>
            <p class="tagline">Phishing Detection & Email Analysis Platform</p>
            <p class="api-info"><strong>API Base URL:</strong> {{ api_base_url }}</p>
        </header>

        <nav class="tab-navigation">
            <button class="tab-button active" onclick="switchTab(event, 'insert-tab')" data-tab="insert">
                üì• Insert Email
            </button>
            <button class="tab-button" onclick="switchTab(event, 'analyze-tab')" data-tab="analyze">
                üîç Analyze Email
            </button>
            <button class="tab-button" onclick="switchTab(event, 'enhanced-tab')" data-tab="enhanced">
                ‚ö° Enhanced Analysis
            </button>
            <button class="tab-button" onclick="switchTab(event, 'ensemble-tab')" data-tab="ensemble">
                üéØ Ensemble Analysis
            </button>
            <button class="tab-button" onclick="switchTab(event, 'report-tab')" data-tab="report">
                üö® Report False Positive
            </button>
            <button class="tab-button" onclick="switchTab(event, 'eml-tab')" data-tab="eml">
                üìÅ EML File Processing
            </button>
        </nav>

        <main class="tab-content">
            <section id="insert-tab" class="tab-panel active">
                <div class="panel-header">
                    <h2>üì• Insert Email</h2>
                    <p class="panel-description">Add a new email to the system for training and analysis</p>
                </div>
                
                <form class="email-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="insert-subject">Subject *</label>
                            <input type="text" id="insert-subject" placeholder="Enter email subject" required />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="insert-body">Body *</label>
                        <textarea id="insert-body" rows="6" placeholder="Enter email body content" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="insert-sender">Sender Email *</label>
                            <input type="email" id="insert-sender" placeholder="sender@example.com" required />
                        </div>
                        <div class="form-group">
                            <label for="insert-recipient">Recipient Email</label>
                            <input type="email" id="insert-recipient" placeholder="recipient@example.com" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="insert-reply_to">Reply To</label>
                            <input type="email" id="insert-reply_to" placeholder="replyto@example.com" />
                        </div>
                        <div class="form-group">
                            <label for="insert-attachments">Attachments (comma-separated)</label>
                            <input type="text" id="insert-attachments" placeholder="file1.pdf, file2.doc" />
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="insert-type">Email Type *</label>
                            <select id="insert-type" required>
                                <option value="">Select email type</option>
                                <option value="transactional">Transactional</option>
                                <option value="business">Business</option>
                                <option value="newsletter">Newsletter</option>
                                <option value="notification">Notification</option>
                                <option value="marketing">Marketing</option>
                                <option value="spam">Spam</option>
                                <option value="bounced">Bounced</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="insert-customerId">Customer ID</label>
                            <input type="text" id="insert-customerId" placeholder="12345" />
                        </div>
                    </div>
                    
                    <button type="button" class="primary-button" onclick="insertEmail()">
                        üì§ Insert Email
                    </button>
                </form>
                
                <div id="insert-result" class="result"></div>
            </section>

            <section id="analyze-tab" class="tab-panel">
                <div class="panel-header">
                    <h2>üîç Analyze Email</h2>
                    <p class="panel-description">Analyze an email for phishing detection and threat assessment</p>
                </div>
                
                <form class="email-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="analyze-subject">Subject *</label>
                            <input type="text" id="analyze-subject" placeholder="Enter email subject" required />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="analyze-body">Body *</label>
                        <textarea id="analyze-body" rows="6" placeholder="Enter email body content" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="analyze-sender">Sender Email *</label>
                            <input type="email" id="analyze-sender" placeholder="sender@example.com" required />
                        </div>
                        <div class="form-group">
                            <label for="analyze-recipient">Recipient Email</label>
                            <input type="email" id="analyze-recipient" placeholder="recipient@example.com" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="analyze-reply_to">Reply To</label>
                            <input type="email" id="analyze-reply_to" placeholder="replyto@example.com" />
                        </div>
                        <div class="form-group">
                            <label for="analyze-customerId">Customer ID</label>
                            <input type="text" id="analyze-customerId" placeholder="12345" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="analyze-attachments">Attachments (comma-separated)</label>
                        <input type="text" id="analyze-attachments" placeholder="file1.pdf, file2.doc" />
                    </div>
                    
                    <button type="button" class="primary-button" onclick="analyzeEmail()">
                        üîç Analyze Email
                    </button>
                </form>
                
                <div id="analyze-result" class="result"></div>
            </section>

            <section id="enhanced-tab" class="tab-panel">
                <div class="panel-header">
                    <h2>‚ö° Enhanced Analysis</h2>
                    <p class="panel-description">Compare original vs enhanced model predictions with detailed improvements</p>
                </div>

                <form class="email-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="enhanced-subject">Subject *</label>
                            <input type="text" id="enhanced-subject" placeholder="Enter email subject" required />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="enhanced-body">Body *</label>
                        <textarea id="enhanced-body" rows="6" placeholder="Enter email body content" required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="enhanced-sender">Sender Email *</label>
                            <input type="email" id="enhanced-sender" placeholder="sender@example.com" required />
                        </div>
                        <div class="form-group">
                            <label for="enhanced-recipient">Recipient Email</label>
                            <input type="email" id="enhanced-recipient" placeholder="recipient@example.com" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="enhanced-reply_to">Reply To</label>
                            <input type="email" id="enhanced-reply_to" placeholder="replyto@example.com" />
                        </div>
                        <div class="form-group">
                            <label for="enhanced-customerId">Customer ID</label>
                            <input type="text" id="enhanced-customerId" placeholder="12345" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="enhanced-attachments">Attachments (comma-separated)</label>
                        <input type="text" id="enhanced-attachments" placeholder="file1.pdf, file2.doc" />
                    </div>

                    <button type="button" class="primary-button" onclick="analyzeEmailEnhanced()">
                        ‚ö° Enhanced Analysis
                    </button>
                </form>

                <div id="enhanced-result" class="result"></div>
            </section>

            <section id="ensemble-tab" class="tab-panel">
                <div class="panel-header">
                    <h2>üéØ Ensemble Analysis</h2>
                    <p class="panel-description">Combine multiple model predictions with HuggingFace integration for maximum accuracy</p>
                </div>

                <form class="email-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ensemble-subject">Subject *</label>
                            <input type="text" id="ensemble-subject" placeholder="Enter email subject" required />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="ensemble-body">Body *</label>
                        <textarea id="ensemble-body" rows="6" placeholder="Enter email body content" required></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="ensemble-sender">Sender Email *</label>
                            <input type="email" id="ensemble-sender" placeholder="sender@example.com" required />
                        </div>
                        <div class="form-group">
                            <label for="ensemble-recipient">Recipient Email</label>
                            <input type="email" id="ensemble-recipient" placeholder="recipient@example.com" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="ensemble-reply_to">Reply To</label>
                            <input type="email" id="ensemble-reply_to" placeholder="replyto@example.com" />
                        </div>
                        <div class="form-group">
                            <label for="ensemble-customerId">Customer ID</label>
                            <input type="text" id="ensemble-customerId" placeholder="12345" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="ensemble-attachments">Attachments (comma-separated)</label>
                            <input type="text" id="ensemble-attachments" placeholder="file1.pdf, file2.doc" />
                        </div>
                        <div class="form-group">
                            <label for="ensemble-huggingface_score">HuggingFace Score (0-100)</label>
                            <input type="number" id="ensemble-huggingface_score" placeholder="65" min="0" max="100" />
                        </div>
                    </div>

                    <button type="button" class="primary-button" onclick="analyzeEmailEnsemble()">
                        üéØ Ensemble Analysis
                    </button>
                </form>

                <div id="ensemble-result" class="result"></div>
            </section>

            <section id="report-tab" class="tab-panel">
                <div class="panel-header">
                    <h2>üö® Report False Positive</h2>
                    <p class="panel-description">Report an email that was incorrectly flagged as phishing</p>
                </div>
                
                <form class="email-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="report-subject">Subject *</label>
                            <input type="text" id="report-subject" placeholder="Enter email subject" required />
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="report-body">Body *</label>
                        <textarea id="report-body" rows="6" placeholder="Enter email body content" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="report-sender">Sender Email *</label>
                            <input type="email" id="report-sender" placeholder="sender@example.com" required />
                        </div>
                        <div class="form-group">
                            <label for="report-recipient">Recipient Email</label>
                            <input type="email" id="report-recipient" placeholder="recipient@example.com" />
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="report-reply_to">Reply To</label>
                            <input type="email" id="report-reply_to" placeholder="replyto@example.com" />
                        </div>
                        <div class="form-group">
                            <label for="report-customerId">Customer ID</label>
                            <input type="text" id="report-customerId" placeholder="12345" />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="report-attachments">Attachments (comma-separated)</label>
                        <input type="text" id="report-attachments" placeholder="file1.pdf, file2.doc" />
                    </div>
                    
                    <button type="button" class="primary-button" onclick="reportFalsePositive()">
                        üö® Report False Positive
                    </button>
                </form>
                
                <div id="report-result" class="result"></div>
            </section>

            <section id="eml-tab" class="tab-panel">
                <div class="panel-header">
                    <h2>üìÅ EML File Processing</h2>
                    <p class="panel-description">Upload and process EML files with automatic parsing</p>
                </div>
                
                <form class="email-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="eml-action">Action *</label>
                            <select id="eml-action" required>
                                <option value="">Select action</option>
                                <option value="analyze">üîç Analyze</option>
                                <option value="insert">üì• Insert</option>
                                <option value="report_false_positive">üö® Report False Positive</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="eml-customerId">Customer ID</label>
                            <input type="text" id="eml-customerId" placeholder="12345" />
                        </div>
                    </div>

                    <div id="insert-options" class="form-group" style="display:none;">
                        <label for="insert-label">Insert as Type *</label>
                        <select id="insert-label">
                            <option value="">Select email type</option>
                            <option value="transactional">Transactional</option>
                            <option value="business">Business</option>
                            <option value="newsletter">Newsletter</option>
                            <option value="notification">Notification</option>
                            <option value="marketing">Marketing</option>
                            <option value="spam">Spam</option>
                            <option value="bounced">Bounced</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="eml-file">EML File *</label>
                        <div class="file-upload-area">
                            <input type="file" id="eml-file" accept=".eml" required />
                            <div class="file-upload-text">
                                <span class="upload-icon">üìé</span>
                                <span>Choose EML file or drag and drop</span>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="primary-button" onclick="handleEml()">
                        üìÅ Upload & Process EML
                    </button>
                </form>
                
                <div id="eml-result" class="result"></div>
            </section>
        </main>
    </div>

    <script>
        const API_BASE_URL = "{{ api_base_url }}";

        // Tab switching functionality
        function switchTab(event, tabId) {
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Remove active class from all tab panels
            const tabPanels = document.querySelectorAll('.tab-panel');
            tabPanels.forEach(panel => panel.classList.remove('active'));
            
            // Add active class to clicked button
            event.currentTarget.classList.add('active');
            
            // Show the selected tab panel
            document.getElementById(tabId).classList.add('active');
        }

        // Initialize tab functionality when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            // Set up EML action dropdown functionality
            const emlActionSelect = document.getElementById('eml-action');
            const insertOptionsDiv = document.getElementById('insert-options');
            
            if (emlActionSelect && insertOptionsDiv) {
                emlActionSelect.addEventListener('change', () => {
                    if (emlActionSelect.value === 'insert') {
                        insertOptionsDiv.style.display = 'block';
                    } else {
                        insertOptionsDiv.style.display = 'none';
                    }
                });
            }

            // Add keyboard navigation for tabs
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach((button, index) => {
                button.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowLeft') {
                        e.preventDefault();
                        const prevIndex = index === 0 ? tabButtons.length - 1 : index - 1;
                        tabButtons[prevIndex].focus();
                        tabButtons[prevIndex].click();
                    } else if (e.key === 'ArrowRight') {
                        e.preventDefault();
                        const nextIndex = index === tabButtons.length - 1 ? 0 : index + 1;
                        tabButtons[nextIndex].focus();
                        tabButtons[nextIndex].click();
                    }
                });
            });

            // File upload drag and drop enhancement
            const fileInputs = document.querySelectorAll('input[type="file"]');
            fileInputs.forEach(fileInput => {
                const uploadArea = fileInput.closest('.file-upload-area');
                if (uploadArea) {
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        uploadArea.addEventListener(eventName, preventDefaults, false);
                    });

                    ['dragenter', 'dragover'].forEach(eventName => {
                        uploadArea.addEventListener(eventName, highlight, false);
                    });

                    ['dragleave', 'drop'].forEach(eventName => {
                        uploadArea.addEventListener(eventName, unhighlight, false);
                    });

                    uploadArea.addEventListener('drop', handleDrop, false);

                    function preventDefaults(e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }

                    function highlight(e) {
                        uploadArea.classList.add('highlight');
                    }

                    function unhighlight(e) {
                        uploadArea.classList.remove('highlight');
                    }

                    function handleDrop(e) {
                        const dt = e.dataTransfer;
                        const files = dt.files;
                        fileInput.files = files;
                        
                        // Update the display text
                        const fileText = uploadArea.querySelector('.file-upload-text span:last-child');
                        if (fileText && files.length > 0) {
                            fileText.textContent = files[0].name;
                        }
                    }
                }
            });
        });

        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function validateInputs(form) {
            const errors = [];

            if (!form.subject.trim()) {
                errors.push('Subject is required');
            }
            if (!form.body.trim()) {
                errors.push('Body is required');
            }
            if (!form.sender.trim()) {
                errors.push('Sender is required');
            } else if (!validateEmail(form.sender)) {
                errors.push('Sender must be a valid email address');
            }
            if (form.recipient && !validateEmail(form.recipient)) {
                errors.push('Recipient must be a valid email address');
            }
            if (form.reply_to && !validateEmail(form.reply_to)) {
                errors.push('Reply To must be a valid email address');
            }

            return errors;
        }

        function setLoading(resultDiv, isLoading, message = '') {
            if (isLoading) {
                resultDiv.className = 'result loading';
                resultDiv.innerHTML = `<div class="spinner"></div> ${message}`;
            }
        }

        function setResult(resultDiv, success, message) {
            resultDiv.className = success ? 'result success' : 'result error';
            resultDiv.textContent = message;
        }

        function parseAttachments(attachmentsStr) {
            if (!attachmentsStr || !attachmentsStr.trim()) return [];
            return attachmentsStr.split(',').map(att => att.trim()).filter(att => att.length > 0);
        }

        async function insertEmail() {
            const form = {
                subject: document.getElementById('insert-subject').value,
                body: document.getElementById('insert-body').value,
                sender: document.getElementById('insert-sender').value,
                recipient: document.getElementById('insert-recipient').value,
                reply_to: document.getElementById('insert-reply_to').value,
                type: document.getElementById('insert-type').value,
                customerId: document.getElementById('insert-customerId').value,
                attachments: document.getElementById('insert-attachments').value
            };

            const resultDiv = document.getElementById('insert-result');

            // Validate inputs
            const errors = validateInputs(form);
            if (errors.length > 0) {
                setResult(resultDiv, false, 'Validation errors: ' + errors.join(', '));
                return;
            }

            const payload = {
                subject: form.subject,
                body: form.body,
                sender: form.sender,
                recipient: form.recipient || null,
                reply_to: form.reply_to || null,
                attachments: parseAttachments(form.attachments),
                type: form.type,
                customerId: form.customerId || null
            };

            setLoading(resultDiv, true, "Inserting email...");
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

                const resp = await fetch(`${API_BASE_URL}/insert`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const data = await resp.json();
                
                if (resp.ok) {
                    setResult(resultDiv, true, data.message || 'Email inserted successfully');
                } else {
                    setResult(resultDiv, false, `Error (${resp.status}): ${data.detail || 'Unknown error'}`);
                }
            } catch (e) {
                if (e.name === 'AbortError') {
                    setResult(resultDiv, false, 'Request timed out. Please try again.');
                } else if (e instanceof TypeError) {
                    setResult(resultDiv, false, 'Network error. Please check your connection.');
                } else {
                    setResult(resultDiv, false, `Error: ${e.message}`);
                }
            }
        }

        async function analyzeEmail() {
            const form = {
                subject: document.getElementById('analyze-subject').value,
                body: document.getElementById('analyze-body').value,
                sender: document.getElementById('analyze-sender').value,
                recipient: document.getElementById('analyze-recipient').value,
                reply_to: document.getElementById('analyze-reply_to').value,
                customerId: document.getElementById('analyze-customerId').value,
                attachments: document.getElementById('analyze-attachments').value
            };

            const resultDiv = document.getElementById('analyze-result');

            // Validate inputs
            const errors = validateInputs(form);
            if (errors.length > 0) {
                setResult(resultDiv, false, 'Validation errors: ' + errors.join(', '));
                return;
            }

            const payload = {
                subject: form.subject,
                body: form.body,
                sender: form.sender,
                recipient: form.recipient || null,
                reply_to: form.reply_to || null,
                attachments: parseAttachments(form.attachments),
                customerId: form.customerId || null
            };

            setLoading(resultDiv, true, "Analyzing email...");
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const resp = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const data = await resp.json();
                
                if (resp.ok) {
                    resultDiv.className = 'result success';
                    const score = data.phishing_score || 0;
                    const riskLevel = score < 31 ? 'Low' : score < 61 ? 'Medium' : 'High';
                    const riskColor = score < 31 ? '#28a745' : score < 61 ? '#ffc107' : '#dc3545';

                    resultDiv.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="background: ${riskColor}; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold;">
                                Score: ${score}/100
                            </div>
                            <div style="color: ${riskColor}; font-weight: bold;">
                                Risk: ${riskLevel} (${data.closest_match || 'unknown'})
                            </div>
                            <div style="color: #666;">
                                Confidence: ${data.confidence_level || 'Unknown'}
                            </div>
                        </div>
                        <details>
                            <summary style="cursor: pointer; font-weight: bold; margin-bottom: 0.5rem;">Analysis Details</summary>
                            <pre style="margin-top: 0.5rem;">${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    setResult(resultDiv, false, `Error (${resp.status}): ${data.detail || 'Unknown error'}`);
                }
            } catch (e) {
                if (e.name === 'AbortError') {
                    setResult(resultDiv, false, 'Request timed out. Please try again.');
                } else if (e instanceof TypeError) {
                    setResult(resultDiv, false, 'Network error. Please check your connection.');
                } else {
                    setResult(resultDiv, false, `Error: ${e.message}`);
                }
            }
        }

        async function reportFalsePositive() {
            const form = {
                subject: document.getElementById('report-subject').value,
                body: document.getElementById('report-body').value,
                sender: document.getElementById('report-sender').value,
                recipient: document.getElementById('report-recipient').value,
                reply_to: document.getElementById('report-reply_to').value,
                customerId: document.getElementById('report-customerId').value,
                attachments: document.getElementById('report-attachments').value
            };

            const resultDiv = document.getElementById('report-result');

            // Validate inputs
            const errors = validateInputs(form);
            if (errors.length > 0) {
                setResult(resultDiv, false, 'Validation errors: ' + errors.join(', '));
                return;
            }

            const payload = {
                subject: form.subject,
                body: form.body,
                sender: form.sender,
                recipient: form.recipient || null,
                reply_to: form.reply_to || null,
                attachments: parseAttachments(form.attachments),
                customerId: form.customerId || null
            };

            setLoading(resultDiv, true, "Reporting false positive...");
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const resp = await fetch(`${API_BASE_URL}/report_false_positive`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const data = await resp.json();
                
                if (resp.ok) {
                    setResult(resultDiv, true, data.message || 'False positive reported successfully');
                } else {
                    setResult(resultDiv, false, `Error (${resp.status}): ${data.detail || 'Unknown error'}`);
                }
            } catch (e) {
                if (e.name === 'AbortError') {
                    setResult(resultDiv, false, 'Request timed out. Please try again.');
                } else if (e instanceof TypeError) {
                    setResult(resultDiv, false, 'Network error. Please check your connection.');
                } else {
                    setResult(resultDiv, false, `Error: ${e.message}`);
                }
            }
        }

        async function handleEml() {
            const fileInput = document.getElementById('eml-file');
            const action = document.getElementById('eml-action').value;
            const custId = document.getElementById('eml-customerId').value;
            const resultDiv = document.getElementById('eml-result');
            const isInsert = (action === 'insert');
            const insertLabel = isInsert ? document.getElementById('insert-label').value : null;

            if (!fileInput.files || fileInput.files.length === 0) {
                setResult(resultDiv, false, "Please select an EML file first.");
                return;
            }

            const file = fileInput.files[0];
            if (!file.name.toLowerCase().endsWith('.eml')) {
                setResult(resultDiv, false, "Please select a valid EML file.");
                return;
            }

            setLoading(resultDiv, true, "Parsing EML file...");
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 60000); // 60s for file operations

                const formData = new FormData();
                formData.append('file', file);

                const parseResp = await fetch(`${API_BASE_URL}/parse_eml`, {
                    method: 'POST',
                    body: formData,
                    signal: controller.signal
                });
                
                const parseData = await parseResp.json();
                
                if (!parseResp.ok) {
                    clearTimeout(timeoutId);
                    setResult(resultDiv, false, `Error parsing EML (${parseResp.status}): ${parseData.detail || 'Unknown error'}`);
                    return;
                }

                const { subject, body, sender, recipient } = parseData;

                // Update loading message for the action
                setLoading(resultDiv, true, `EML parsed successfully. Performing ${action}...`);

                let endpoint = "";
                let payload = { subject, body, sender, recipient: recipient || null, customerId: custId || null };

                if (action === 'analyze') {
                    endpoint = '/analyze';
                } else if (action === 'insert') {
                    endpoint = '/insert';
                    payload.type = insertLabel;
                } else if (action === 'report_false_positive') {
                    endpoint = '/report_false_positive';
                }

                const finalResp = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                const finalData = await finalResp.json();
                
                if (finalResp.ok) {
                    if (action === 'analyze') {
                        resultDiv.className = 'result success';
                        const score = finalData.phishing_score || 0;
                        const riskLevel = score < 31 ? 'Low' : score < 61 ? 'Medium' : 'High';
                        const riskColor = score < 31 ? '#28a745' : score < 61 ? '#ffc107' : '#dc3545';

                        resultDiv.innerHTML = `
                            <strong>EML Analysis Complete:</strong>
                            <div style="display: flex; align-items: center; gap: 1rem; margin: 1rem 0;">
                                <div style="background: ${riskColor}; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold;">
                                    Score: ${score}/100
                                </div>
                                <div style="color: ${riskColor}; font-weight: bold;">
                                    Risk: ${riskLevel} (${finalData.closest_match || 'unknown'})
                                </div>
                                <div style="color: #666;">
                                    Confidence: ${finalData.confidence_level || 'Unknown'}
                                </div>
                            </div>
                            <details>
                                <summary style="cursor: pointer; font-weight: bold; margin-bottom: 0.5rem;">Analysis Details</summary>
                                <pre style="margin-top: 0.5rem;">${JSON.stringify(finalData, null, 2)}</pre>
                            </details>
                        `;
                    } else {
                        setResult(resultDiv, true, finalData.message || `${action} completed successfully`);
                    }
                } else {
                    setResult(resultDiv, false, `Action error (${finalResp.status}): ${finalData.detail || 'Unknown error'}`);
                }
            } catch (e) {
                if (e.name === 'AbortError') {
                    setResult(resultDiv, false, 'Request timed out. Please try again.');
                } else if (e instanceof TypeError) {
                    setResult(resultDiv, false, 'Network error. Please check your connection.');
                } else {
                    setResult(resultDiv, false, `Error: ${e.message}`);
                }
            }
        }

        async function analyzeEmailEnhanced() {
            const form = {
                subject: document.getElementById('enhanced-subject').value,
                body: document.getElementById('enhanced-body').value,
                sender: document.getElementById('enhanced-sender').value,
                recipient: document.getElementById('enhanced-recipient').value,
                reply_to: document.getElementById('enhanced-reply_to').value,
                customerId: document.getElementById('enhanced-customerId').value,
                attachments: document.getElementById('enhanced-attachments').value
            };

            const resultDiv = document.getElementById('enhanced-result');

            // Validate inputs
            const errors = validateInputs(form);
            if (errors.length > 0) {
                setResult(resultDiv, false, 'Validation errors: ' + errors.join(', '));
                return;
            }

            const payload = {
                subject: form.subject,
                body: form.body,
                sender: form.sender,
                recipient: form.recipient || null,
                reply_to: form.reply_to || null,
                attachments: parseAttachments(form.attachments),
                customerId: form.customerId || null
            };

            setLoading(resultDiv, true, "Performing enhanced analysis...");

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const resp = await fetch(`${API_BASE_URL}/analyze/enhanced`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const data = await resp.json();

                if (resp.ok) {
                    resultDiv.className = 'result success';

                    const originalScore = data.original_score || 0;
                    const enhancedScore = data.enhanced_score || 0;
                    const improvement = enhancedScore - originalScore;

                    const originalRiskLevel = originalScore < 31 ? 'Low' : originalScore < 61 ? 'Medium' : 'High';
                    const enhancedRiskLevel = enhancedScore < 31 ? 'Low' : enhancedScore < 61 ? 'Medium' : 'High';

                    const originalColor = originalScore < 31 ? '#28a745' : originalScore < 61 ? '#ffc107' : '#dc3545';
                    const enhancedColor = enhancedScore < 31 ? '#28a745' : enhancedScore < 61 ? '#ffc107' : '#dc3545';

                    resultDiv.innerHTML = `
                        <h3>Enhanced Analysis Comparison</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div style="border: 2px solid ${originalColor}; border-radius: 8px; padding: 1rem;">
                                <h4 style="margin: 0 0 0.5rem 0; color: ${originalColor};">Original Model</h4>
                                <div style="background: ${originalColor}; color: white; padding: 0.5rem; border-radius: 4px; text-align: center; font-weight: bold;">
                                    ${originalScore}/100 - ${originalRiskLevel} Risk
                                </div>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                                    Prediction: ${data.original_prediction || 'unknown'}<br>
                                    Confidence: ${data.original_confidence || 'Unknown'}
                                </p>
                            </div>
                            <div style="border: 2px solid ${enhancedColor}; border-radius: 8px; padding: 1rem;">
                                <h4 style="margin: 0 0 0.5rem 0; color: ${enhancedColor};">Enhanced Model</h4>
                                <div style="background: ${enhancedColor}; color: white; padding: 0.5rem; border-radius: 4px; text-align: center; font-weight: bold;">
                                    ${enhancedScore}/100 - ${enhancedRiskLevel} Risk
                                </div>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">
                                    Prediction: ${data.enhanced_prediction || 'unknown'}<br>
                                    Confidence: ${data.enhanced_confidence || 'Unknown'}
                                </p>
                            </div>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <strong>Improvements Applied:</strong> ${data.improvement_applied ? 'Yes' : 'No'}<br>
                            <strong>Score Change:</strong> ${improvement > 0 ? '+' : ''}${improvement} points<br>
                            <strong>Rule Boost:</strong> ${data.rule_boost || 0} points<br>
                            <strong>Adaptive Threshold:</strong> ${data.adaptive_threshold || 50}%
                        </div>
                        <details>
                            <summary style="cursor: pointer; font-weight: bold; margin-bottom: 0.5rem;">Full Analysis Details</summary>
                            <pre style="margin-top: 0.5rem;">${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    setResult(resultDiv, false, `Error (${resp.status}): ${data.detail || 'Unknown error'}`);
                }
            } catch (e) {
                if (e.name === 'AbortError') {
                    setResult(resultDiv, false, 'Request timed out. Please try again.');
                } else if (e instanceof TypeError) {
                    setResult(resultDiv, false, 'Network error. Please check your connection.');
                } else {
                    setResult(resultDiv, false, `Error: ${e.message}`);
                }
            }
        }

        async function analyzeEmailEnsemble() {
            const form = {
                subject: document.getElementById('ensemble-subject').value,
                body: document.getElementById('ensemble-body').value,
                sender: document.getElementById('ensemble-sender').value,
                recipient: document.getElementById('ensemble-recipient').value,
                reply_to: document.getElementById('ensemble-reply_to').value,
                customerId: document.getElementById('ensemble-customerId').value,
                attachments: document.getElementById('ensemble-attachments').value,
                huggingface_score: document.getElementById('ensemble-huggingface_score').value
            };

            const resultDiv = document.getElementById('ensemble-result');

            // Validate inputs
            const errors = validateInputs(form);
            if (errors.length > 0) {
                setResult(resultDiv, false, 'Validation errors: ' + errors.join(', '));
                return;
            }

            const payload = {
                subject: form.subject,
                body: form.body,
                sender: form.sender,
                recipient: form.recipient || null,
                reply_to: form.reply_to || null,
                attachments: parseAttachments(form.attachments),
                customerId: form.customerId || null
            };

            let url = `${API_BASE_URL}/analyze/ensemble`;
            if (form.huggingface_score && form.huggingface_score.trim()) {
                url += `?huggingface_score=${encodeURIComponent(form.huggingface_score)}`;
            }

            setLoading(resultDiv, true, "Performing ensemble analysis...");

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);

                const resp = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal
                });

                clearTimeout(timeoutId);
                const data = await resp.json();

                if (resp.ok) {
                    resultDiv.className = 'result success';

                    const ensembleScore = data.ensemble_score || data.phishing_score || 0;
                    const riskLevel = ensembleScore < 31 ? 'Low' : ensembleScore < 61 ? 'Medium' : 'High';
                    const riskColor = ensembleScore < 31 ? '#28a745' : ensembleScore < 61 ? '#ffc107' : '#dc3545';

                    resultDiv.innerHTML = `
                        <h3>Ensemble Analysis Result</h3>
                        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                            <div style="background: ${riskColor}; color: white; padding: 0.75rem 1.5rem; border-radius: 25px; font-weight: bold; font-size: 1.1rem;">
                                Ensemble Score: ${ensembleScore}/100
                            </div>
                            <div style="color: ${riskColor}; font-weight: bold; font-size: 1.1rem;">
                                Risk Level: ${riskLevel}
                            </div>
                        </div>
                        ${data.ensemble_prediction ? `
                            <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                <strong>Ensemble Prediction:</strong> ${data.ensemble_prediction}<br>
                                <strong>Confidence:</strong> ${data.confidence || 'Unknown'}<br>
                                ${form.huggingface_score ? `<strong>HuggingFace Input:</strong> ${form.huggingface_score}<br>` : ''}
                                <strong>Model Combination:</strong> Multiple ML models + Vector similarity
                            </div>
                        ` : ''}
                        <details>
                            <summary style="cursor: pointer; font-weight: bold; margin-bottom: 0.5rem;">Analysis Details & Reasoning</summary>
                            <pre style="margin-top: 0.5rem;">${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    setResult(resultDiv, false, `Error (${resp.status}): ${data.detail || 'Unknown error'}`);
                }
            } catch (e) {
                if (e.name === 'AbortError') {
                    setResult(resultDiv, false, 'Request timed out. Please try again.');
                } else if (e instanceof TypeError) {
                    setResult(resultDiv, false, 'Network error. Please check your connection.');
                } else {
                    setResult(resultDiv, false, `Error: ${e.message}`);
                }
            }
        }
    </script>
</body>
</html>
